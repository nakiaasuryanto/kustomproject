<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kustomproject</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-config.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="passwordOverlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Access Key</h2>
            <input type="password" id="accessKeyInput" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4" placeholder="Access Key">
            <button id="submitAccessKey" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">Submit</button>
            <p id="keyError" class="text-red-500 text-sm mt-2 hidden">Incorrect key. Please try again.</p>
        </div>
    </div>

    <div id="dashboardContent" class="container mx-auto px-4 py-8 hidden">
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">üìä Dashboard Summary</h1>
            <p class="text-gray-600 mb-4">Financial Overview & Analytics</p>
            <div class="space-x-3">
                <a href="index.html" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors">
                    ‚Üê Back to Input
                </a>
                <a href="transactions.html" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors">
                    üìú View History
                </a>
            </div>
        </header>

                <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Total Sales -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Penjualan</p>
                        <p id="totalSales" class="text-2xl font-bold text-green-600">Rp 0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span id="salesCount" class="text-sm text-gray-500">0 transactions</span>
                </div>
            </div>

            <!-- Total Expenses -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Pengeluaran</p>
                        <p id="totalExpenses" class="text-2xl font-bold text-red-600">Rp 0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span id="expensesCount" class="text-sm text-gray-500">0 transactions</span>
                </div>
            </div>

            <!-- Cash in Hand -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Cash in Hand</p>
                        <p id="cashInHand" class="text-2xl font-bold text-blue-600">Rp 0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-xs text-gray-500">Payment: CASH</span>
                </div>
            </div>

            <!-- Cash in Bank (Mandiri) -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Cash in Bank (Mandiri)</p>
                        <p id="cashInBank" class="text-2xl font-bold text-purple-600">Rp 0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path>
                        </svg>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="text-xs text-gray-500">Payment: TF</span>
                </div>
            </div>
        </div>

        <!-- Product Sales Distribution (Full Width) -->
        <div class="bg-white p-6 rounded-lg shadow-lg mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Product Sales Distribution</h3>
                </div>
                
                <!-- Monthly Filter for Chart -->
                <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
                        <div>
                            <label class="block text-sm text-gray-600 mb-1">Month</label>
                            <input type="month" id="pieChartMonth" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <button id="updatePieChart" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors w-full">
                                Update Chart
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Pie Chart -->
                    <div class="relative" style="height: 300px;">
                        <canvas id="productSalesPieChart"></canvas>
                    </div>
                    
                    <!-- Chart Stats -->
                    <div id="pieChartStats" class="grid grid-cols-1 gap-4">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <!-- Loading/Error States -->
                <div id="pieChartLoadingState" class="text-center py-8 hidden">
                    <div class="text-gray-600">Loading chart data...</div>
                </div>

                <div id="pieChartErrorState" class="text-center py-8 hidden">
                    <div class="text-red-600">Error loading chart data. Please try again.</div>
                </div>

                <div id="pieChartEmptyState" class="text-center py-8 hidden">
                    <div class="text-gray-600">No sales data found for the selected period.</div>
                </div>
        </div>

        <!-- Charts Row (Transaction Chart + PIC Sales Summary) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Transaction Chart with Date Filter -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">Transaction Chart by Date</h3>
                
                <!-- Monthly Filter -->
                <div class="mb-4 flex gap-3">
                    <div>
                        <label class="block text-xs text-gray-600 mb-1">Month</label>
                        <input type="month" id="chartMonth" class="px-2 py-1 border border-gray-300 rounded text-sm">
                    </div>
                    <div class="flex items-end">
                        <button id="updateChart" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                            Update
                        </button>
                    </div>
                </div>
                
                <canvas id="dailyChart" width="400" height="200"></canvas>
            </div>

            <!-- PIC Sales Summary -->
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h3 class="text-lg font-semibold mb-4">PIC Sales Summary</h3>
                <div class="mb-4 text-sm text-gray-600">
                    <p>üìä Sales transactions only</p>
                    <p>üí∞ Total transactions by PIC</p>
                </div>
                
                <!-- Monthly Filter -->
                <div class="mb-4">
                    <label class="block text-xs text-gray-600 mb-1">Month</label>
                    <input type="month" id="picMonth" class="px-2 py-1 border border-gray-300 rounded text-sm">
                </div>
                
                <div id="picSalesStats" class="space-y-3">
                    <!-- PIC sales stats will be populated here -->
                </div>
            </div>
        </div>

        
    </div>

    <script>
        const CORRECT_KEY = "Nakiacantik"; // Replace with your desired key

        document.addEventListener('DOMContentLoaded', function() {
            const passwordOverlay = document.getElementById('passwordOverlay');
            const accessKeyInput = document.getElementById('accessKeyInput');
            const submitAccessKey = document.getElementById('submitAccessKey');
            const keyError = document.getElementById('keyError');
            const dashboardContent = document.getElementById('dashboardContent');

            // Check if already authenticated (e.g., from a previous session)
            if (sessionStorage.getItem('authenticated') === 'true') {
                passwordOverlay.classList.add('hidden');
                dashboardContent.classList.remove('hidden');
                initializeDashboard();
            } else {
                passwordOverlay.classList.remove('hidden');
                dashboardContent.classList.add('hidden');
            }

            submitAccessKey.addEventListener('click', function() {
                if (accessKeyInput.value === CORRECT_KEY) {
                    sessionStorage.setItem('authenticated', 'true');
                    passwordOverlay.classList.add('hidden');
                    dashboardContent.classList.remove('hidden');
                    initializeDashboard();
                } else {
                    keyError.classList.remove('hidden');
                    accessKeyInput.value = ''; // Clear input on wrong key
                }
            });

            accessKeyInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAccessKey.click();
                }
            });
        });

        function initializeDashboard() {
            // Original dashboard initialization logic
            initializeDateFilters();
            setupEventListeners();
            fetchDashboardData();
        }

        let allTransactions = [];
        let dailyChart = null;

        // Initialize dashboard
        function initializeDashboard() {
            initializeDateFilters();
            setupEventListeners();
            fetchDashboardData();
            // loadProductChart(); // This is now called within fetchDashboardData
        }

        function initializeDateFilters() {
            const today = new Date();
            const currentMonth = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;
            
            // Set current month for all monthly filters
            document.getElementById('chartMonth').value = currentMonth;
            document.getElementById('pieChartMonth').value = currentMonth;
            document.getElementById('picMonth').value = currentMonth;
        }

        function setupEventListeners() {
            document.getElementById('updateChart').addEventListener('click', updateDailyChart);
            document.getElementById('updatePieChart').addEventListener('click', updateProductChart);
            document.getElementById('picMonth').addEventListener('change', updatePICSalesStats);
        }

        async function fetchDashboardData() {
            try {
                allTransactions = await getTransactions();
                updateSummaryCards(allTransactions);

                // Then, trigger the individual chart updates.
                // These will fetch their own data and won't block the initial page load.
                updateDailyChart();
                updatePICSalesStats();
                updateProductChart();

            } catch (error) {
                console.error('Error fetching dashboard data:', error);
                document.getElementById('loadingState').innerHTML = `
                    <div class="text-red-600">
                        <p>Error loading dashboard data</p>
                        <button onclick="fetchDashboardData()" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function updateSummaryCards(transactions) {
            const salesTransactions = transactions.filter(t => t.type === 'penjualan');
            const expenseTransactions = transactions.filter(t => t.type === 'pengeluaran');

            const totalSales = salesTransactions.reduce((sum, t) => {
                const saleAmount = (Number(t.manual_price) > 0) ? Number(t.manual_price) : Number(t.total) || 0;
                return sum + saleAmount;
            }, 0);
            const totalExpenses = expenseTransactions.reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

            const cashSales = salesTransactions
                .filter(t => t.payment_method === 'CASH')
                .reduce((sum, t) => {
                    const saleAmount = (Number(t.manual_price) > 0) ? Number(t.manual_price) : Number(t.total) || 0;
                    return sum + saleAmount;
                }, 0);
            
            const cashExpenses = expenseTransactions
                .filter(t => t.payment_method === 'CASH')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

            const tfSales = salesTransactions
                .filter(t => t.payment_method === 'Mandiri' || t.payment_method === 'TF')
                .reduce((sum, t) => {
                    const saleAmount = (Number(t.manual_price) > 0) ? Number(t.manual_price) : Number(t.total) || 0;
                    return sum + saleAmount;
                }, 0);

            const tfExpenses = expenseTransactions
                .filter(t => t.payment_method === 'Mandiri' || t.payment_method === 'TF')
                .reduce((sum, t) => sum + (Number(t.amount) || 0), 0);

            const cashInHand = cashSales - cashExpenses;
            const cashInBank = tfSales - tfExpenses;

            document.getElementById('totalSales').textContent = formatCurrency(totalSales);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            document.getElementById('cashInHand').textContent = formatCurrency(cashInHand);
            document.getElementById('cashInBank').textContent = formatCurrency(cashInBank);
            document.getElementById('salesCount').textContent = `${salesTransactions.length} transactions`;
            document.getElementById('expensesCount').textContent = `${expenseTransactions.length} transactions`;
        }

        async function updatePICSalesStats() {
            const selectedMonth = document.getElementById('picMonth').value;
            const picStats = {};
            
            const [year, month] = selectedMonth.split('-');
            const startDate = `${year}-${month}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];

            // Fetch only the data needed for this chart
            const salesTransactions = await getTransactions({ type: 'penjualan', startDate, endDate });

            salesTransactions.forEach(transaction => {
                const pic = transaction.pic_sales;
                if (pic) {
                    if (!picStats[pic]) {
                        picStats[pic] = {
                            name: pic,
                            transactionCount: 0,
                            totalSales: 0,
                            totalItems: 0,
                            totalManualPrice: 0,
                            commission: 0
                        };
                    }
                    
                    const saleAmount = (Number(transaction.manual_price) > 0) ? Number(transaction.manual_price) : Number(transaction.total) || 0;

                    picStats[pic].transactionCount++;
                    picStats[pic].totalSales += saleAmount;
                    picStats[pic].totalManualPrice += Number(transaction.manual_price) || 0;

                    if (transaction.items) {
                        transaction.items.forEach(item => {
                            picStats[pic].totalItems += item.quantity;
                        });
                    }
                }
            });
            
            const picStatsContainer = document.getElementById('picSalesStats');
            const sortedPICs = Object.values(picStats).sort((a, b) => b.totalSales - a.totalSales);
            
            sortedPICs.forEach(pic => {
                pic.commission = pic.totalSales * 0.20;
            });
            
            picStatsContainer.innerHTML = sortedPICs.map(pic => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-medium text-gray-900">${pic.name}</h4>
                        <p class="text-sm text-gray-600">${pic.transactionCount} sales transactions</p>
                        <p class="text-sm text-gray-600">${pic.totalItems} items sold</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-green-600">${formatCurrency(pic.totalSales)}</p>
                        <p class="text-xs text-gray-500">Total Sales</p>
                        <p class="font-semibold text-blue-600 mt-1">${formatCurrency(pic.commission)}</p>
                        <p class="text-xs text-gray-500">Commission (20%)</p>
                    </div>
                </div>
            `).join('');
            
            if (sortedPICs.length === 0) {
                picStatsContainer.innerHTML = '<p class="text-gray-500 text-center">No sales PIC data available</p>';
            }
        }


        function createDailyChart() {
            updateDailyChart();
        }

        async function updateDailyChart() {
            const ctx = document.getElementById('dailyChart').getContext('2d');
            
            const selectedMonth = document.getElementById('chartMonth').value;
            
            if (!selectedMonth) {
                console.log('Please select a month');
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const startDate = `${year}-${month}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];

            // Fetch only the data needed for this chart
            const transactions = await getTransactions({ startDate, endDate });
            const dailyData = getDailyData(transactions, startDate, endDate);
            
            if (dailyChart) {
                dailyChart.destroy();
            }
            
            if (!dailyData.labels.length) {
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                ctx.font = '14px Arial';
                ctx.fillStyle = '#6B7280';
                ctx.textAlign = 'center';
                ctx.fillText('No data in selected date range', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dailyData.labels,
                    datasets: [
                        {
                            label: 'Penjualan',
                            data: dailyData.sales,
                            borderColor: 'rgb(34, 197, 94)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Pengeluaran',
                            data: dailyData.expenses,
                            borderColor: 'rgb(239, 68, 68)',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            tension: 0.3,
                            fill: false,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                maxTicksLimit: 6,
                                callback: function(value) {
                                    return formatCurrencyShort(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Tanggal'
                            }
                        }
                    }
                }
            });
        }

        function getDailyData(transactions, startDate, endDate) {
            const dailyStats = {};
            
            if (!transactions || transactions.length === 0) {
                return { labels: [], sales: [], expenses: [] };
            }
            
            transactions.forEach(transaction => {
                const dateStr = transaction.date.split('T')[0];
                
                if (!dailyStats[dateStr]) {
                    dailyStats[dateStr] = { sales: 0, expenses: 0 };
                }
                
                if (transaction.type === 'penjualan') {
                    dailyStats[dateStr].sales += Number(transaction.total) || 0;
                } else if (transaction.type === 'pengeluaran') {
                    dailyStats[dateStr].expenses += Number(transaction.amount) || 0;
                }
            });
            
            const dates = [];
            const salesData = [];
            const expensesData = [];
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = d.toISOString().split('T')[0];
                const label = d.toLocaleDateString('id-ID', { month: '2-digit', day: '2-digit' });
                
                dates.push(label);
                salesData.push(dailyStats[dateStr]?.sales || 0);
                expensesData.push(dailyStats[dateStr]?.expenses || 0);
            }
            
            return {
                labels: dates,
                sales: salesData,
                expenses: expensesData
            };
        }

        // Utility functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID');
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return 'Rp 0';
            return `Rp ${amount.toLocaleString()}`;
        }

        function formatCurrencyShort(amount) {
            if (amount >= 1000000) {
                return `${(amount / 1000000).toFixed(1)}M`;
            } else if (amount >= 1000) {
                return `${(amount / 1000).toFixed(1)}K`;
            }
            return amount.toString();
        }

        // Pie Chart functionality
        let productChart = null;
        let filteredTransactions = [];

        async function loadProductChart() {
            // Load chart data with current month
            await updateProductChart();
        }

        async function updateProductChart() {
            const selectedMonth = document.getElementById('pieChartMonth').value;
            
            if (!selectedMonth) {
                console.log('Please select a month');
                return;
            }
            
            const [year, month] = selectedMonth.split('-');
            const startDate = `${year}-${month}-01`;
            const endDate = new Date(year, month, 0).toISOString().split('T')[0];
            
            try {
                showPieChartLoading();
                
                const transactions = await getTransactions({ type: 'penjualan', startDate, endDate });
                
                if (transactions.length === 0) {
                    showPieChartEmpty();
                    return;
                }
                
                const productSales = {};
                transactions.forEach(transaction => {
                    if (transaction.items) {
                        transaction.items.forEach(item => {
                            const productName = item.product_name;
                            if (!productSales[productName]) {
                                productSales[productName] = { quantity: 0, total: 0 };
                            }
                            productSales[productName].quantity += item.quantity;
                            productSales[productName].total += (item.quantity * item.price);
                        });
                    }
                    if (transaction.free_items) {
                        transaction.free_items.forEach(item => {
                            const productName = item.name;
                            if (!productSales[productName]) {
                                productSales[productName] = { quantity: 0, total: 0 };
                            }
                            productSales[productName].quantity += 1;
                        });
                    }
                });
                
                const sortedProducts = Object.entries(productSales)
                    .sort((a, b) => b[1].total - a[1].total);
                
                const labels = sortedProducts.map(([product]) => product);
                const quantities = sortedProducts.map(([, data]) => data.quantity);
                
                const colors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#36A2EB'
                ];
                
                hideAllPieChartStates();
                createPieChart(labels, quantities, colors);
                updatePieChartStats(sortedProducts);
                
            } catch (error) {
                console.error('Error loading chart data:', error);
                showPieChartError();
            }
        }

        function createPieChart(labels, data, colors) {
            const ctx = document.getElementById('productSalesPieChart').getContext('2d');
            
            // Destroy existing chart
            if (productChart) {
                productChart.destroy();
            }
            
            productChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.raw / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.raw} units (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePieChartStats(sortedProducts) {
            const statsContainer = document.getElementById('pieChartStats');
            const totalQuantity = sortedProducts.reduce((sum, [, data]) => sum + data.quantity, 0);
            const totalRevenue = sortedProducts.reduce((sum, [, data]) => sum + data.total, 0);
            
            statsContainer.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-lg text-center">
                    <div class="text-blue-800 font-semibold">Total Products</div>
                    <div class="text-xl font-bold text-blue-600">${sortedProducts.length}</div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg text-center">
                    <div class="text-green-800 font-semibold">Total Quantity</div>
                    <div class="text-xl font-bold text-green-600">${totalQuantity}</div>
                </div>
            `;
        }

        

        // Pie chart state functions
        function showPieChartLoading() {
            hideAllPieChartStates();
            document.getElementById('pieChartLoadingState').classList.remove('hidden');
        }

        function showPieChartError() {
            hideAllPieChartStates();
            document.getElementById('pieChartErrorState').classList.remove('hidden');
        }

        function showPieChartEmpty() {
            hideAllPieChartStates();
            document.getElementById('pieChartEmptyState').classList.remove('hidden');
        }

        function hideAllPieChartStates() {
            document.getElementById('pieChartLoadingState').classList.add('hidden');
            document.getElementById('pieChartErrorState').classList.add('hidden');
            document.getElementById('pieChartEmptyState').classList.add('hidden');
        }
    </script>
</body>
</html>
